#!/usr/bin/env bash
# pre-push.sample
set -euo pipefail

# -----------------------------
# Logging (stdout + stderr)
# -----------------------------
SCRIPT_NAME="git_pre_push"
REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"
LOG_DIR="${REPO_ROOT}/logs/${SCRIPT_NAME}"
mkdir -p "$LOG_DIR"

# keep last 30 logs (macOS friendly)
# NOTE: avoid "ls" failing when there are 0 matching files (set -e would exit)
if compgen -G "${LOG_DIR}/${SCRIPT_NAME}_"*.log > /dev/null; then
  ls -1t "${LOG_DIR}/${SCRIPT_NAME}_"*.log | tail -n +31 | while read -r f; do
    rm -f "$f"
  done
fi

RUN_TS="$(date +%Y-%m-%d_%H-%M-%S)"
LOG_FILE="${LOG_DIR}/${SCRIPT_NAME}_${RUN_TS}.log"
LATEST_LOG="${LOG_DIR}/${SCRIPT_NAME}_latest.log"

exec > >(tee -a "$LOG_FILE" "$LATEST_LOG") 2>&1
trap 'rc=$?; if [[ $rc -eq 0 ]]; then echo "✅ RESULT: SUCCESS"; else echo "❌ RESULT: FAILED (exit=$rc)"; fi' EXIT

echo ""
echo "ℹ️  Log file: $LOG_FILE"
echo ""
echo "---- Context ----"
echo "user=$(whoami) host=$(hostname)"
echo "pwd=$(pwd)"
echo "git=$(git --version | head -n 1 2>/dev/null || echo n/a)"
echo "node=$(node -v 2>/dev/null || echo n/a) npm=$(npm -v 2>/dev/null || echo n/a)"
echo "------------------"
echo ""

# ===== Config (override via env if needed) =====
BUCKET="${BUCKET:-assetscdnstack-heavyassetsbucket72601c17-nip5jdtseu6y}"
CF_DIST="${CF_DIST:-E2VLTYLWTD0YS4}"
AWS_REGION="${AWS_REGION:-us-east-1}"
AWS_PROFILE="${AWS_PROFILE:-tejas-sso}"
# ===============================================

# Skip on CI or when explicitly requested
if [[ "${SKIP_ASSET_SYNC:-0}" == "1" || "${CI:-}" == "true" ]]; then
  echo "[pre-push] Skipping asset sync."
  echo ""
  exit 0
fi

echo "[pre-push] Sync sprites (side) to s3://${BUCKET}/ships/sprites/"
aws s3 sync src/assets/ships/sprites "s3://${BUCKET}/ships/sprites/" \
  --exclude "*/top/*" \
  --cache-control "public,max-age=86400" \
  --delete
echo ""

if [[ -d src/assets/ships/glb ]]; then
  echo "[pre-push] Sync GLB to s3://${BUCKET}/ships/glb/"
  aws s3 sync src/assets/ships/glb "s3://${BUCKET}/ships/glb/" \
    --cache-control "public,max-age=86400" \
    --delete
  echo ""
fi

echo "[pre-push] Invalidate CloudFront"
aws cloudfront create-invalidation \
  --distribution-id "${CF_DIST}" \
  --paths "/ships/sprites/*" "/ships/glb/*" >/dev/null
echo ""

echo "[pre-push] Done."
echo ""
