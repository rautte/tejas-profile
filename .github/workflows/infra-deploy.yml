name: Deploy Infra (CDK)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

concurrency:
  group: "release-main"
  cancel-in-progress: true

permissions:
  contents: read
  id-token: write

jobs:
  cdk:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: us-east-1

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect infra changes (infra/cdk/**)
        id: changes
        shell: bash
        run: |
          set -euo pipefail

          # For workflow_dispatch we can’t reliably diff against "before"
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "infra_changed=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.sha }}"

          # If BEFORE is missing or invalid, deploy (safe default)
          if [[ -z "$BEFORE" || "$BEFORE" == "0000000000000000000000000000000000000000" ]]; then
            echo "infra_changed=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Ensure BEFORE exists locally (fetch-depth=0 already helps, but be safe)
          if ! git cat-file -e "${BEFORE}^{commit}" 2>/dev/null; then
            echo "infra_changed=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Diff: $BEFORE..$AFTER"
          if git diff --name-only "$BEFORE" "$AFTER" | grep -q '^infra/cdk/'; then
            echo "infra_changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "infra_changed=false" >> "$GITHUB_OUTPUT"
          fi

      - uses: actions/setup-node@v4
        if: steps.changes.outputs.infra_changed == 'true'
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: infra/cdk/package-lock.json

      - name: Install CDK deps
        if: steps.changes.outputs.infra_changed == 'true'
        working-directory: infra/cdk
        run: npm ci

      - name: Configure AWS credentials (OIDC)
        if: steps.changes.outputs.infra_changed == 'true'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::978416150779:role/tejas-profile-github-deployer
          aws-region: ${{ env.AWS_REGION }}

      - name: CDK bootstrap (safe no-op if already)
        if: steps.changes.outputs.infra_changed == 'true'
        working-directory: infra/cdk
        env:
          GITHUB_DEPLOYER_ROLE_ARN: arn:aws:iam::978416150779:role/tejas-profile-github-deployer
        run: npx cdk bootstrap aws://978416150779/us-east-1

      - name: CDK deploy (Snapshots + Assets)
        if: steps.changes.outputs.infra_changed == 'true'
        working-directory: infra/cdk
        env:
          OWNER_TOKEN: ${{ secrets.REACT_APP_OWNER_SECRET }}
          GITHUB_DEPLOYER_ROLE_ARN: arn:aws:iam::978416150779:role/tejas-profile-github-deployer
        run: |
          npx cdk deploy TejasProfileSnapshotsStack AssetsCdnStack --require-approval never

      - name: Skip message (no infra change)
        if: steps.changes.outputs.infra_changed != 'true'
        run: echo "No infra/cdk changes detected — skipping CDK deploy."