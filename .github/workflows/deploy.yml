name: Build & Deploy (Pages)

on:
  workflow_run:
    workflows: ["Deploy Infra (CDK)"]
    types: [completed]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    runs-on: ubuntu-latest
    outputs:
      GIT_SHA: ${{ steps.meta.outputs.GIT_SHA }}
      GIT_SHA_SHORT: ${{ steps.meta.outputs.GIT_SHA_SHORT }}
      PROFILE_VERSION: ${{ steps.meta.outputs.PROFILE_VERSION }}
      BUILD_TIME: ${{ steps.meta.outputs.BUILD_TIME }}
      REPO_ARTIFACT_KEY: ${{ steps.s3.outputs.S3_KEY }}
      REPO_ARTIFACT_SHA256: ${{ steps.ziprepo.outputs.SHA256 }}
      DIFF_FILES_JSON: ${{ steps.diff.outputs.DIFF_FILES_JSON }}
      DIFF_TAG_VALUE: ${{ steps.diff.outputs.DIFF_TAG_VALUE }}

    env:
      AWS_REGION: ${{ vars.AWS_REGION }}
      SNAPSHOTS_BUCKET: ${{ secrets.SNAPSHOTS_BUCKET }}
      REPO_BUCKET: ${{ secrets.REPO_BUCKET }}
      REPO_URL: ${{ secrets.REPO_URL }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Ensure zip available
        shell: bash
        run: |
          set -euo pipefail
          if ! command -v zip >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y zip
          fi
      
      - name: Compute diffFiles (this run)
        id: diff
        shell: bash
        run: |
          set -euo pipefail

          BASE_SHA="$(git rev-parse HEAD^ 2>/dev/null || true)"

          CHANGED=""
          if [ -n "${BASE_SHA}" ]; then
            CHANGED="$(git diff --name-only "${BASE_SHA}" HEAD || true)"
          fi

          # Ensure jq exists (build job doesn't install jq elsewhere)
          command -v jq >/dev/null 2>&1 || (sudo apt-get update && sudo apt-get install -y jq)

          arr_json () {
            local s="${1:-}"
            if [ -z "${s}" ]; then
              echo '[]'
            else
              printf '%s\n' "${s}" | jq -R -s 'split("\n")[:-1]'
            fi
          }

          INFRA_FILES="$(printf '%s\n' "${CHANGED}" | grep '^infra/cdk/' || true)"
          DATA_FILES="$(printf '%s\n' "${CHANGED}" | grep '^src/data/' || true)"
          UIUX_FILES="$(printf '%s\n' "${CHANGED}" | grep '^src/' | grep -v '^src/data/' || true)"
          GHWF_FILES="$(printf '%s\n' "${CHANGED}" | grep '^\.github/workflows/' || true)"

          INFRA_JSON="$(arr_json "${INFRA_FILES}")"
          DATA_JSON="$(arr_json "${DATA_FILES}")"
          UIUX_JSON="$(arr_json "${UIUX_FILES}")"
          GHWF_JSON="$(arr_json "${GHWF_FILES}")"

          DIFF_FILES_JSON="$(jq -n \
            --argjson infra "${INFRA_JSON}" \
            --argjson data "${DATA_JSON}" \
            --argjson uiux "${UIUX_JSON}" \
            --argjson githubWorkflow "${GHWF_JSON}" \
            '{infra:$infra, data:$data, uiux:$uiux, githubWorkflow:$githubWorkflow}')"

          parts=()
          [ "$(echo "${INFRA_JSON}" | jq 'length')" -gt 0 ] && parts+=("infra")
          [ "$(echo "${DATA_JSON}" | jq 'length')" -gt 0 ] && parts+=("data")
          [ "$(echo "${UIUX_JSON}" | jq 'length')" -gt 0 ] && parts+=("uiux")
          [ "$(echo "${GHWF_JSON}" | jq 'length')" -gt 0 ] && parts+=("githubWorkflow")

          if [ "${#parts[@]}" -eq 0 ]; then
            DIFF_TAG_VALUE="none"
          else
            IFS=_; DIFF_TAG_VALUE="${parts[*]}"; unset IFS
          fi

          {
            echo "DIFF_TAG_VALUE=${DIFF_TAG_VALUE}"
            echo "DIFF_FILES_JSON<<EOF"
            echo "${DIFF_FILES_JSON}"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

          echo "[diff] DIFF_TAG_VALUE=${DIFF_TAG_VALUE}"
          echo "[diff] DIFF_FILES_JSON=${DIFF_FILES_JSON}"


      - name: Compute version metadata
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          GIT_SHA="$(git rev-parse HEAD)"
          GIT_SHA_SHORT="$(git rev-parse --short HEAD)"
          BUILD_TIME="$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          PROFILE_VERSION="pv_${GIT_SHA_SHORT}"

          echo "GIT_SHA=$GIT_SHA" >> $GITHUB_OUTPUT
          echo "GIT_SHA_SHORT=$GIT_SHA_SHORT" >> $GITHUB_OUTPUT
          echo "BUILD_TIME=$BUILD_TIME" >> $GITHUB_OUTPUT
          echo "PROFILE_VERSION=$PROFILE_VERSION" >> $GITHUB_OUTPUT

      - name: Create repo code snapshot zip (allowlist)
        id: ziprepo
        shell: bash
        run: |
          set -euo pipefail
          ARTIFACT_NAME="profile_repo__${{ steps.meta.outputs.GIT_SHA_SHORT }}.zip"
          ARTIFACT_PATH="/tmp/${ARTIFACT_NAME}"

          zip -r "$ARTIFACT_PATH" \
            src public infra scripts data \
            .husky/pre-commit .husky/pre-push \
            .gitignore \
            infra/cdk/.gitignore infra/cdk/.npmignore \
            package.json package-lock.json \
            tailwind.config.js postcss.config.js tsconfig.json \
            README.md \
            -x "public/snapshots/*" \
            -x "**/.DS_Store" \
            -x "**/*.log" \
            -x ".env" -x ".env.*" \
            -x "node_modules/*" \
            -x "build/*" \
            -x "logs/*" \
            -x ".git/*"

          SHA256="$(sha256sum "$ARTIFACT_PATH" | awk '{print $1}')"
          echo "ARTIFACT_NAME=$ARTIFACT_NAME" >> $GITHUB_OUTPUT
          echo "ARTIFACT_PATH=$ARTIFACT_PATH" >> $GITHUB_OUTPUT
          echo "SHA256=$SHA256" >> $GITHUB_OUTPUT

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::978416150779:role/tejas-profile-github-deployer
          aws-region: ${{ env.AWS_REGION }}

      - name: Upload repo code snapshot to S3
        id: s3
        shell: bash
        run: |
          set -euo pipefail
          REPO_KEY="profiles/${{ steps.meta.outputs.PROFILE_VERSION }}/repo/${{ steps.ziprepo.outputs.ARTIFACT_NAME }}"
          test -n "${REPO_BUCKET}" || (echo "REPO_BUCKET is empty. Set it in Actions Variables." && exit 1)
          aws s3 cp "${{ steps.ziprepo.outputs.ARTIFACT_PATH }}" "s3://${REPO_BUCKET}/${REPO_KEY}" --content-type "application/zip"
          echo "S3_KEY=$REPO_KEY" >> $GITHUB_OUTPUT

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - run: npm ci

      - name: Write build env (.env)
        shell: bash
        run: |
          set -euo pipefail
          echo "REACT_APP_SNAPSHOTS_API=${{ secrets.REACT_APP_SNAPSHOTS_API }}" >> .env
          echo "REACT_APP_CHECKPOINT_TAG=gha_${GITHUB_RUN_ID}" >> .env
          echo "REACT_APP_CDN_BASE=https://d2n9g8msgr1y81.cloudfront.net" >> .env
          echo "REACT_APP_PROFILE_VERSION=${{ steps.meta.outputs.PROFILE_VERSION }}" >> .env
          echo "REACT_APP_GIT_SHA=${{ steps.meta.outputs.GIT_SHA }}" >> .env
          echo "REACT_APP_BUILD_TIME=${{ steps.meta.outputs.BUILD_TIME }}" >> .env
          echo "REACT_APP_OWNER_SECRET=${{ secrets.REACT_APP_OWNER_SECRET }}" >> .env
          echo "REACT_APP_REPO=${REPO_URL}" >> .env
          echo "REACT_APP_GIT_REF=${GITHUB_REF}" >> .env
          echo "REACT_APP_GH_RUN_ID=${GITHUB_RUN_ID}" >> .env
          echo "REACT_APP_REPO_ARTIFACT_KEY=${{ steps.s3.outputs.S3_KEY }}" >> .env
          echo "REACT_APP_REPO_ARTIFACT_SHA256=${{ steps.ziprepo.outputs.SHA256 }}" >> .env
          echo "REACT_APP_GEO_DATASET_URL=${{ secrets.REACT_APP_GEO_DATASET_URL }}" >> .env

      - run: npm run build

      - uses: actions/upload-pages-artifact@v3
        with:
          path: ./build

  deploy:
    needs: build
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ${{ vars.AWS_REGION }}
      SNAPSHOTS_BUCKET: ${{ secrets.SNAPSHOTS_BUCKET }}
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - id: deployment
        uses: actions/deploy-pages@v4

      - name: Configure AWS credentials (OIDC) for history write
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::978416150779:role/tejas-profile-github-deployer
          aws-region: ${{ env.AWS_REGION }}

      - name: Ensure jq
        shell: bash
        run: |
          set -e
          command -v jq >/dev/null 2>&1 || (sudo apt-get update && sudo apt-get install -y jq)

      - name: Update deploy history (active + previous)
        shell: bash
        run: |
          set -euo pipefail
          KEY="deploy/history.json"
          TMP_OLD="/tmp/deploy_history_old.json"
          TMP_NEW="/tmp/deploy_history_new.json"

          GIT_SHA="${{ needs.build.outputs.GIT_SHA }}"
          PROFILE_VERSION="${{ needs.build.outputs.PROFILE_VERSION }}"
          DEPLOYED_AT="$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          SOURCE="gha"

          aws s3 cp "s3://${SNAPSHOTS_BUCKET}/${KEY}" "${TMP_OLD}" >/dev/null 2>&1 || true
          if [ ! -s "${TMP_OLD}" ]; then echo '{}' > "${TMP_OLD}"; fi

          OLD_ACTIVE_SHA="$(jq -r '.active.gitSha // empty' "${TMP_OLD}")"
          OLD_ACTIVE_PV="$(jq -r '.active.profileVersionId // empty' "${TMP_OLD}")"
          OLD_ACTIVE_AT="$(jq -r '.active.deployedAt // empty' "${TMP_OLD}")"
          OLD_ACTIVE_SRC="$(jq -r '.active.source // empty' "${TMP_OLD}")"

          jq -n \
            --arg gitSha "${GIT_SHA}" \
            --arg pv "${PROFILE_VERSION}" \
            --arg at "${DEPLOYED_AT}" \
            --arg src "${SOURCE}" \
            --arg prevSha "${OLD_ACTIVE_SHA}" \
            --arg prevPv "${OLD_ACTIVE_PV}" \
            --arg prevAt "${OLD_ACTIVE_AT}" \
            --arg prevSrc "${OLD_ACTIVE_SRC}" \
            --slurpfile old "${TMP_OLD}" \
            '
            def oldTimeline:
              (if ($old|length>0 and ($old[0].timeline|type)=="array") then $old[0].timeline else [] end);

            {
              active: { gitSha: $gitSha, profileVersionId: $pv, deployedAt: $at, source: $src },
              previous: (if ($prevSha|length)>0 then { gitSha: $prevSha, profileVersionId: $prevPv, deployedAt: $prevAt, source: $prevSrc } else null end),
              timeline: ( ([{ gitSha: $gitSha, profileVersionId: $pv, deployedAt: $at, source: $src }] + oldTimeline) | unique_by(.gitSha) | .[0:25] )
            }
            ' > "${TMP_NEW}"

          aws s3 cp "${TMP_NEW}" "s3://${SNAPSHOTS_BUCKET}/${KEY}" \
            --content-type "application/json" \
            --cache-control "no-store"

  publish_ci_snapshot:
    name: Publish CI Snapshot (prod)
    needs: [build, deploy]
    runs-on: ubuntu-latest
    if: github.ref_name == 'main'

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Publish snapshot to Snapshots API
        env:
          STAGE: prod
          SNAPSHOTS_API: ${{ secrets.TEJAS_PROFILE_SNAPSHOTS_API_PROD }}
          OWNER_TOKEN: ${{ secrets.TEJAS_PROFILE_OWNER_TOKEN_PROD }}

          GIT_SHA: ${{ needs.build.outputs.GIT_SHA }}
          PROFILE_VERSION: ${{ needs.build.outputs.PROFILE_VERSION }}
          CHECKPOINT_TAG: gha_${{ github.run_id }}

          REPO_ARTIFACT_KEY: ${{ needs.build.outputs.REPO_ARTIFACT_KEY }}
          REPO_ARTIFACT_SHA256: ${{ needs.build.outputs.REPO_ARTIFACT_SHA256 }}

          # ✅ add this (fixes buildTime null)
          BUILD_TIME: ${{ needs.build.outputs.BUILD_TIME }}

          # ✅ optional but recommended for full parity with Analytics payload shape
          GIT_REF: ${{ github.ref }}
          GH_RUN_ID: ${{ github.run_id }}
          REPO_URL: ${{ vars.REPO_URL || secrets.REPO_URL }}
          TIMEZONE: America/Los_Angeles
          DIFF_FILES_JSON: ${{ needs.build.outputs.DIFF_FILES_JSON }}
          DIFF_TAG_VALUE: ${{ needs.build.outputs.DIFF_TAG_VALUE }}
        run: node scripts/publish-ci-snapshot.mjs

