name: Redeploy (Owner)

on:
  workflow_dispatch:
    inputs:
      gitSha:
        description: "Commit SHA to deploy"
        required: true
      checkpointTag:
        description: "Checkpoint tag (optional)"
        required: false
        default: "unknown"
      profileVersion:
        description: "Profile version id (optional)"
        required: false
        default: "unknown"
      sourceSnapshotKey:
        description: "Snapshot key that triggered this (optional)"
        required: false
        default: "unknown"
      reason:
        description: "Reason (optional)"
        required: false
        default: "owner trigger"

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: ${{ vars.AWS_REGION }}
      # IMPORTANT: this should point to the repo zip bucket if you want repo zip uploads here.
      # If you only need redeploy, you can remove the S3 zip steps.
      REPO_BUCKET: ${{ vars.REPO_BUCKET }}
      REPO_URL: ${{ vars.REPO_URL }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.gitSha }}

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - run: npm ci

      - name: Compute version metadata
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          GIT_SHA="$(git rev-parse HEAD)"
          GIT_SHA_SHORT="$(git rev-parse --short HEAD)"
          BUILD_TIME="$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          PROFILE_VERSION="${{ inputs.profileVersion }}"
          if [ -z "$PROFILE_VERSION" ] || [ "$PROFILE_VERSION" = "unknown" ]; then
            PROFILE_VERSION="pv_${GIT_SHA_SHORT}"
          fi
          echo "GIT_SHA=$GIT_SHA" >> $GITHUB_OUTPUT
          echo "GIT_SHA_SHORT=$GIT_SHA_SHORT" >> $GITHUB_OUTPUT
          echo "BUILD_TIME=$BUILD_TIME" >> $GITHUB_OUTPUT
          echo "PROFILE_VERSION=$PROFILE_VERSION" >> $GITHUB_OUTPUT

      - name: Write build env (.env)
        shell: bash
        run: |
          set -euo pipefail
          echo "REACT_APP_CDN_BASE=https://d2n9g8msgr1y81.cloudfront.net" >> .env
          echo "REACT_APP_PROFILE_VERSION=${{ steps.meta.outputs.PROFILE_VERSION }}" >> .env
          echo "REACT_APP_GIT_SHA=${{ steps.meta.outputs.GIT_SHA }}" >> .env
          echo "REACT_APP_BUILD_TIME=${{ steps.meta.outputs.BUILD_TIME }}" >> .env
          echo "REACT_APP_REPO=${REPO_URL}" >> .env
          echo "REACT_APP_GIT_REF=${{ inputs.gitSha }}" >> .env
          echo "REACT_APP_GH_RUN_ID=${GITHUB_RUN_ID}" >> .env
          echo "REACT_APP_CHECKPOINT_TAG=${{ inputs.checkpointTag }}" >> .env

      - run: npm run build

      - uses: actions/upload-pages-artifact@v3
        with:
          path: ./build

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
    steps:
      - uses: actions/deploy-pages@v4
