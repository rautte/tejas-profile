name: Redeploy (Owner)

on:
  workflow_dispatch:
    inputs:
      gitSha:
        description: "Commit SHA to deploy"
        required: true
      checkpointTag:
        description: "Checkpoint tag (optional)"
        required: false
        default: "unknown"
      profileVersion:
        description: "Profile version id (optional)"
        required: false
        default: "unknown"
      sourceSnapshotKey:
        description: "Snapshot key that triggered this (optional)"
        required: false
        default: "unknown"
      reason:
        description: "Reason (optional)"
        required: false
        default: "owner trigger"

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      GIT_SHA: ${{ steps.meta.outputs.GIT_SHA }}
      GIT_SHA_SHORT: ${{ steps.meta.outputs.GIT_SHA_SHORT }}
      PROFILE_VERSION: ${{ steps.meta.outputs.PROFILE_VERSION }}
      BUILD_TIME: ${{ steps.meta.outputs.BUILD_TIME }}


    env:
      AWS_REGION: ${{ vars.AWS_REGION }}
      # IMPORTANT: this should point to the repo zip bucket if you want repo zip uploads here.
      # If you only need redeploy, you can remove the S3 zip steps.
      REPO_BUCKET: ${{ vars.REPO_BUCKET }}
      REPO_URL: ${{ vars.REPO_URL }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.gitSha }}

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - run: npm ci

      - name: Compute version metadata
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          GIT_SHA="$(git rev-parse HEAD)"
          GIT_SHA_SHORT="$(git rev-parse --short HEAD)"
          BUILD_TIME="$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          PROFILE_VERSION="${{ inputs.profileVersion }}"
          if [ -z "$PROFILE_VERSION" ] || [ "$PROFILE_VERSION" = "unknown" ]; then
            PROFILE_VERSION="pv_${GIT_SHA_SHORT}"
          fi
          echo "GIT_SHA=$GIT_SHA" >> $GITHUB_OUTPUT
          echo "GIT_SHA_SHORT=$GIT_SHA_SHORT" >> $GITHUB_OUTPUT
          echo "BUILD_TIME=$BUILD_TIME" >> $GITHUB_OUTPUT
          echo "PROFILE_VERSION=$PROFILE_VERSION" >> $GITHUB_OUTPUT

      - name: Write build env (.env)
        shell: bash
        run: |
          set -euo pipefail
          echo "REACT_APP_SNAPSHOTS_API=${{ vars.REACT_APP_SNAPSHOTS_API }}" >> .env
          echo "REACT_APP_CDN_BASE=https://d2n9g8msgr1y81.cloudfront.net" >> .env
          echo "REACT_APP_PROFILE_VERSION=${{ steps.meta.outputs.PROFILE_VERSION }}" >> .env
          echo "REACT_APP_GIT_SHA=${{ steps.meta.outputs.GIT_SHA }}" >> .env
          echo "REACT_APP_BUILD_TIME=${{ steps.meta.outputs.BUILD_TIME }}" >> .env
          echo "REACT_APP_REPO=${REPO_URL}" >> .env
          echo "REACT_APP_GIT_REF=${{ inputs.gitSha }}" >> .env
          echo "REACT_APP_GH_RUN_ID=${GITHUB_RUN_ID}" >> .env
          echo "REACT_APP_CHECKPOINT_TAG=${{ inputs.checkpointTag }}" >> .env

      - run: npm run build

      - uses: actions/upload-pages-artifact@v3
        with:
          path: ./build

  deploy:
    needs: build
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ${{ vars.AWS_REGION }}
      SNAPSHOTS_BUCKET: ${{ vars.SNAPSHOTS_BUCKET }}
    environment:
      name: github-pages
    steps:
      - uses: actions/deploy-pages@v4

      - name: Configure AWS credentials (OIDC) for history write
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::978416150779:role/tejas-profile-github-deployer
          aws-region: ${{ env.AWS_REGION }}

      - name: Ensure jq
        shell: bash
        run: |
          set -e
          command -v jq >/dev/null 2>&1 || (sudo apt-get update && sudo apt-get install -y jq)

      - name: Update deploy history (active + previous)
        shell: bash
        run: |
          set -euo pipefail

          KEY="deploy/history.json"
          TMP_OLD="/tmp/deploy_history_old.json"
          TMP_NEW="/tmp/deploy_history_new.json"

          GIT_SHA="${{ needs.build.outputs.GIT_SHA }}"
          PROFILE_VERSION="${{ needs.build.outputs.PROFILE_VERSION }}"
          DEPLOYED_AT="$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          SOURCE="gha"

          # fetch old (if exists)
          aws s3 cp "s3://${SNAPSHOTS_BUCKET}/${KEY}" "${TMP_OLD}" >/dev/null 2>&1 || true

          if [ -s "${TMP_OLD}" ]; then
            OLD_ACTIVE_SHA="$(jq -r '.active.gitSha // empty' "${TMP_OLD}")"
            OLD_ACTIVE_PV="$(jq -r '.active.profileVersionId // empty' "${TMP_OLD}")"
            OLD_ACTIVE_AT="$(jq -r '.active.deployedAt // empty' "${TMP_OLD}")"
            OLD_ACTIVE_SRC="$(jq -r '.active.source // empty' "${TMP_OLD}")"
          else
            OLD_ACTIVE_SHA=""
            OLD_ACTIVE_PV=""
            OLD_ACTIVE_AT=""
            OLD_ACTIVE_SRC=""
          fi

          jq -n \
            --arg gitSha "${GIT_SHA}" \
            --arg pv "${PROFILE_VERSION}" \
            --arg at "${DEPLOYED_AT}" \
            --arg src "${SOURCE}" \
            --arg prevSha "${OLD_ACTIVE_SHA}" \
            --arg prevPv "${OLD_ACTIVE_PV}" \
            --arg prevAt "${OLD_ACTIVE_AT}" \
            --arg prevSrc "${OLD_ACTIVE_SRC}" \
            --slurpfile old "${TMP_OLD}" \
            '
            def oldTimeline:
              (if ($old|length>0 and ($old[0].timeline|type)=="array") then $old[0].timeline else [] end);

            {
              active: {
                gitSha: $gitSha,
                profileVersionId: $pv,
                deployedAt: $at,
                source: $src
              },
              previous: (if ($prevSha|length)>0 then {
                gitSha: $prevSha,
                profileVersionId: $prevPv,
                deployedAt: $prevAt,
                source: $prevSrc
              } else null end),
              timeline: (
                (
                  [{ gitSha: $gitSha, profileVersionId: $pv, deployedAt: $at, source: $src }]
                  + oldTimeline
                )
                | unique_by(.gitSha)
                | .[0:25]
              )
            }
            ' > "${TMP_NEW}"

          aws s3 cp "${TMP_NEW}" "s3://${SNAPSHOTS_BUCKET}/${KEY}" \
            --content-type "application/json" \
            --cache-control "no-store"

